#!/bin/bash

SRC_FILE_PARAM=$1

if [ -z "$SRC_FILE_PARAM" ]; then
  echo "Usage: `basename $0` <source_file_path>.c"
  exit 1
fi

SRC_FILE_RES_PATH=`find $SRC_PATH -type f -regex ".+$SRC_FILE_PARAM"`

if [ ! -f "$SRC_FILE_RES_PATH" ]; then
  echo "Not found $SRC_FILE_PARAM"
  exit 1
fi

SRC_FILE_REL_PATH=`realpath $SRC_FILE_RES_PATH | awk -v pattern="$SRC_PATH/" '{ gsub(pattern, "");}1'`

SRC_FILE_PATH=`dirname $SRC_FILE_RES_PATH`
SRC_FILE_NAME=`basename $SRC_FILE_RES_PATH`

cd $WORKSPACE_ROOT

FILE_BUILD_PATH=`echo $BUILD_PATH/$SRC_FILE_REL_PATH | sed 's/\.[^.]\+$//g'`

FILE_NAME=`echo $SRC_FILE_NAME | sed 's/\.c//g'`

source $SRC_FILE_PATH/$FILE_NAME.params

[ ! -d $FILE_BUILD_PATH ] && mkdir -p $FILE_BUILD_PATH

sdcc $SDCC_ARGS $SRC_FILE_RES_PATH -o $FILE_BUILD_PATH/

SRC_HEX_FILE="$FILE_NAME.ihx"
SRC_REL_FILE="$FILE_NAME.rel"

if [ $? -eq 0 ]; then
  FILE_TARGET_PATH=`echo $TARGET_PATH/$SRC_FILE_REL_PATH | sed 's/\.c//g'`
  [ ! -d $FILE_TARGET_PATH ] && mkdir -p $FILE_TARGET_PATH

  if [ ! -z "$TARGET_BIN_FILE" ] && [ -f "$FILE_BUILD_PATH/$SRC_HEX_FILE" ]; then
    objcopy -I ihex -O binary $FILE_BUILD_PATH/$SRC_HEX_FILE $FILE_TARGET_PATH/$TARGET_BIN_FILE

    echo ".$FILE_TARGET_PATH/$TARGET_BIN_FILE"
  fi

  if [ ! -z "$TARGET_LIB_FILE" ] && [ -f "$FILE_BUILD_PATH/$SRC_REL_FILE" ]; then
    sdar -rc $FILE_TARGET_PATH/$TARGET_LIB_FILE $FILE_BUILD_PATH/$SRC_REL_FILE
    echo ".$FILE_TARGET_PATH/$TARGET_LIB_FILE"
  fi
fi
